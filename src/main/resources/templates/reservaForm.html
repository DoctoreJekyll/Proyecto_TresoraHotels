<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layout/plantilla}">

<head>
    <title>Reserva Rápida</title>
</head>

<body class="bg-gradient-primary">

<main layout:fragment="contenido" id="main-content" class="main-container" role="main" aria-labelledby="booking-title">
    <div class="center-wrapper" style="min-height: 100vh; display: flex; align-items: center; justify-content: center; width: 100%;">

        <script th:inline="javascript">
            document.addEventListener("DOMContentLoaded", function () {
                const habitacionSelect = document.getElementById('idHabitacion');
                const hotelSelect = document.getElementById('hotelSelect');
                const precioTotalEl = document.getElementById('precioTotal');
                const fechaEntradaEl = document.getElementById('fechaEntrada');
                const fechaSalidaEl = document.getElementById('fechaSalida');

                // --- Event Listeners principales ---
                hotelSelect.addEventListener('change', cargarHabitaciones);
                fechaEntradaEl.addEventListener('change', cargarHabitaciones);
                fechaSalidaEl.addEventListener('change', cargarHabitaciones);
                habitacionSelect.addEventListener('change', calcularPrecioTotal); // Asegurarse de que el cambio de habitación recalcule

                // Escucha cambios en los checkboxes y también en cantidad y descuento para recalcular el precio
                document.querySelectorAll('input[type="checkbox"][name^="productos"]').forEach(cb => {
                    cb.addEventListener('change', calcularPrecioTotal);
                    const group = cb.closest('.checkbox-group');
                    if (group) {
                        group.querySelector('input[name$=".cantidad"]')?.addEventListener('input', calcularPrecioTotal);
                        group.querySelector('input[name$=".descuento"]')?.addEventListener('input', calcularPrecioTotal);
                    }
                });

                // --- Funciones de Lógica ---
                function cargarHabitaciones() {
                    const hotelId = hotelSelect.value;
                    const fechaEntrada = fechaEntradaEl.value;
                    const fechaSalida = fechaSalidaEl.value;

                    if (!hotelId || !fechaEntrada || !fechaSalida) {
                        habitacionSelect.innerHTML = '<option value="" disabled selected>Seleccione hotel y fechas primero</option>';
                        // Si no hay datos completos para la búsqueda, limpiar y recalcular con lo que haya
                        calcularPrecioTotal();
                        return;
                    }

                    habitacionSelect.innerHTML = '<option value="" disabled selected>Cargando habitaciones...</option>';

                    fetch(`/reservas/api/habitaciones?hotelId=${hotelId}&fechaEntrada=${fechaEntrada}&fechaSalida=${fechaSalida}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Error al cargar habitaciones: ' + response.statusText);
                            }
                            return response.json();
                        })
                        .then(data => {
                            habitacionSelect.innerHTML = '<option value="" disabled selected>Seleccione habitación</option>'; // Limpiar y añadir opción por defecto
                            const currentHabitacionId = [[${reservaDTO.idHabitacion}]]; // ID de habitación del DTO
                            let habitacionEncontradaYSeleccionada = false;

                            data.forEach(habitacion => {
                                const option = document.createElement('option');
                                option.value = habitacion.id;
                                option.textContent = habitacion.tipo + ' - Nº ' + habitacion.numeroHabitacion;
                                option.dataset.precio = habitacion.precioBase;

                                if (currentHabitacionId && habitacion.id === currentHabitacionId) {
                                    option.selected = true;
                                    habitacionEncontradaYSeleccionada = true;
                                }
                                habitacionSelect.appendChild(option);
                            });

                            // Si se está editando una reserva y la habitación previamente seleccionada no está disponible
                            // o si el campo estaba vacío, asegúrate de que el select quede en la opción por defecto.
                            if (currentHabitacionId && !habitacionEncontradaYSeleccionada) {
                                // Aquí puedes añadir lógica para notificar que la habitación no está disponible
                                console.warn(`La habitación con ID ${currentHabitacionId} no está disponible para las fechas seleccionadas.`);
                                habitacionSelect.value = ""; // Deseleccionar la opción no disponible
                            }

                            calcularPrecioTotal(); // Recalcular el precio después de cargar y potencialmente seleccionar la habitación
                        })
                        .catch(err => {
                            console.error('Error cargando habitaciones:', err);
                            habitacionSelect.innerHTML = '<option value="" disabled selected>Error al cargar habitaciones</option>';
                            calcularPrecioTotal(); // Recalcular incluso si hay error para limpiar el total
                        });
                }

                function calcularPrecioTotal() {
                    let total = 0;

                    const selectedOption = habitacionSelect.options[habitacionSelect.selectedIndex];
                    const precioHabitacion = selectedOption?.dataset.precio ? parseFloat(selectedOption.dataset.precio) : 0;

                    const fechaEntrada = new Date(fechaEntradaEl.value);
                    const fechaSalida = new Date(fechaSalidaEl.value);

                    // Asegúrate de que las fechas sean válidas y la fecha de salida sea posterior a la de entrada
                    if (isNaN(fechaEntrada) || isNaN(fechaSalida) || fechaEntrada >= fechaSalida) {
                        precioTotalEl.innerText = '0.00 €';
                        const desglose = document.getElementById("desglosePrecio");
                        if (desglose) {
                            desglose.innerText = '';
                        }
                        return; // Salir si las fechas no son válidas
                    }
                    const msPorDia = 1000 * 60 * 60 * 24;
                    const noches = Math.max(0, Math.round((fechaSalida - fechaEntrada) / msPorDia)); // Asegúrate de que noches no sea negativo

                    total += precioHabitacion * noches;

                    document.querySelectorAll('.checkbox-group').forEach(group => {
                        const checkbox = group.querySelector('input[type="checkbox"]');
                        if (checkbox?.checked && checkbox.dataset.precio) {
                            const cantidadInput = group.querySelector('input[name$=".cantidad"]');
                            const descuentoInput = group.querySelector('input[name$=".descuento"]');

                            const cantidad = parseFloat(cantidadInput?.value) || 0;
                            let descuentoPorcentaje = parseFloat(descuentoInput?.value) || 0;
                            descuentoPorcentaje = Math.max(0, Math.min(100, descuentoPorcentaje)); // Asegurar que el descuento esté entre 0 y 100

                            let precioProducto = parseFloat(checkbox.dataset.precio);
                            precioProducto = precioProducto * cantidad;
                            precioProducto = precioProducto * (1 - (descuentoPorcentaje / 100)); // Aplicar descuento
                            total += precioProducto;
                        }
                    });

                    precioTotalEl.innerText = total.toFixed(2) + ' €';

                    const desglose = document.getElementById("desglosePrecio");
                    if (desglose && precioHabitacion > 0 && noches > 0) { // Mostrar desglose solo si hay precio de habitación y noches
                        desglose.innerText = `(${precioHabitacion.toFixed(2)} € x ${noches} noche${noches !== 1 ? 's' : ''})`;
                    } else if (desglose) {
                        desglose.innerText = '';
                    }
                }

                // --- Validación del formulario antes de enviar ---
                document.getElementById("booking-form").addEventListener("submit", function (e) {
                    let error = false;
                    document.querySelectorAll('.checkbox-group').forEach(group => {
                        const checkbox = group.querySelector('input[type="checkbox"]');
                        if (checkbox?.checked) {
                            const cantidad = group.querySelector('input[name$=".cantidad"]');
                            const fecha = group.querySelector('input[name$=".fecha"]');
                            // Si el checkbox está marcado, cantidad y fecha son obligatorios
                            if (!cantidad.value || !fecha.value) {
                                error = true;
                                cantidad.classList.add('is-invalid'); // Añadir clase para resaltar el error
                                fecha.classList.add('is-invalid');
                            } else {
                                cantidad.classList.remove('is-invalid'); // Quitar la clase si es válido
                                fecha.classList.remove('is-invalid');
                            }
                        } else { // Si el checkbox no está marcado, limpiar posibles errores de validación anteriores
                            group.querySelector('input[name$=".cantidad"]')?.classList.remove('is-invalid');
                            group.querySelector('input[name$=".fecha"]')?.classList.remove('is-invalid');
                        }
                    });
                    if (error) {
                        e.preventDefault();
                        alert("Si seleccionas un servicio adicional, debes rellenar cantidad y fecha.");
                    }
                });

                // --- Carga inicial de datos para el modo edición ---
                // Esta lógica debe ejecutarse DESPUÉS de que los listeners estén configurados
                // y antes de la primera llamada a calcularPrecioTotal para que los valores de los productos estén
                // correctamente enlazados con el DTO.

                const productosSeleccionados = /*[[${reservaDTO.productos}]]*/ []; // Thymeleaf inserta el valor aquí
                if (productosSeleccionados && productosSeleccionados.length > 0) {
                    document.querySelectorAll('input[type="checkbox"][name^="productos"]').forEach(function(cb) {
                        const productoIdEnCheckbox = parseInt(cb.value);
                        const pDto = productosSeleccionados.find(p => p.idProducto === productoIdEnCheckbox);

                        if (pDto) {
                            cb.checked = true;
                            const group = cb.closest('.checkbox-group');
                            if (group) {
                                group.querySelector('input[name$=".cantidad"]').value = pDto.cantidad;
                                // Asegúrate de que la fecha se formatee correctamente si no lo está (YYYY-MM-DD)
                                group.querySelector('input[name$=".fecha"]').value = pDto.fecha ? String(pDto.fecha).substring(0, 10) : '';
                                group.querySelector('input[name$=".descuento"]').value = pDto.descuento;
                            }
                        }
                    });
                }

                // --- Carga inicial de habitaciones y cálculo de precio al cargar la página ---
                // Debe ser la última llamada después de que todo el DOM y los valores estén listos.
                if (hotelSelect.value && fechaEntradaEl.value && fechaSalidaEl.value) {
                    // Si ya hay valores de hotel y fechas, cargar habitaciones.
                    // calcularPrecioTotal() se llamará dentro de cargarHabitaciones al finalizar.
                    cargarHabitaciones();
                } else {
                    // Si no hay valores completos para cargar habitaciones (ej. creando una nueva reserva sin datos aún),
                    // simplemente calcular el precio con los valores por defecto o vacíos.
                    calcularPrecioTotal();
                }

            });
        </script>

        <div class="card form-card" style="max-width: 512px; width: 100%; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
            <h1 id="booking-title" class="card-title text-center">Reserva desde Empleado</h1>

            <form th:action="@{/reservas/guardar}" th:object="${reservaDTO}" method="post" id="booking-form">
                <input type="hidden" name="id" th:value="${reservaId}" />

                <p class="card-text mb-4">Complete los campos para reservar su estancia. Todos los campos son obligatorios.</p>

                <div class="form-group mb-4">
                    <label for="nombre">Nombre</label>
                    <input type="text" th:field="*{nombre}" id="nombre" class="form-control" required />
                </div>

                <div class="form-group mb-4">
                    <label for="email">Email</label>
                    <input type="email" th:field="*{email}" id="email" class="form-control" required />
                </div>

                <div class="form-group mb-4">
                    <label for="hotelSelect">Hotel</label>
                    <select th:field="*{hotel}" id="hotelSelect" class="form-control" required>
                        <option value="" disabled>Seleccione un hotel</option>
                        <option th:each="hotel : ${hoteles}"
                                th:value="${hotel.id}"
                                th:text="${hotel.nombre}"
                                th:selected="${hotel.id == reservaDTO.hotel}">
                        </option>
                    </select>
                </div>

                <div class="form-group mb-4">
                    <label for="fechaEntrada">Fecha de Entrada</label>
                    <input type="date" th:field="*{fechaEntrada}" id="fechaEntrada" class="form-control" required />
                </div>

                <div class="form-group mb-4">
                    <label for="fechaSalida">Fecha de Salida</label>
                    <input type="date" th:field="*{fechaSalida}" id="fechaSalida" class="form-control" required />
                </div>

                <div class="form-group mb-4">
                    <label for="idHabitacion">Habitación</label>
                    <select th:field="*{idHabitacion}" id="idHabitacion" class="form-control" required>
                        <option value="" disabled selected>Seleccione hotel y fechas primero</option>
                        <option th:if="${reservaDTO.idHabitacion != null}"
                                th:value="${reservaDTO.idHabitacion}"
                                th:text="${'Habitación actual (cargando...) '}"
                                th:selected="true">
                        </option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="idMetodoPagoSeleccionado">Método de Pago:</label>
                    <select class="form-control" id="idMetodoPagoSeleccionado" th:field="*{idMetodoPagoSeleccionado}" required>
                        <option value="">Seleccione un método de pago</option>
                        <option th:each="metodo : ${reservaDTO.metodoPagos}"
                                th:value="${metodo.id}"
                                th:text="${metodo.nombre}">
                            Tarjeta de Crédito
                        </option>
                    </select>
                </div>

                <div class="form-group mb-4">
                    <label for="pax">Número de huéspedes</label>
                    <input type="number" min="1" max="10" th:field="*{pax}" id="pax" class="form-control" required />
                </div>

                <div class="form-group mb-4">
                    <label for="comentarios">Comentarios</label>
                    <textarea th:field="*{comentarios}" id="comentarios" class="form-control" rows="3" placeholder="Comentarios adicionales..."></textarea>
                </div>

                <div class="form-group mb-4">
                    <label for="estado">Estado de la Reserva</label>
                    <select th:field="*{estado}" id="estado" class="form-control" required>
                        <option th:each="estadoOpt : ${T(com.atm.buenas_practicas_java.entities.Reserva.ESTADO_RESERVA).values()}"
                                th:value="${estadoOpt}"
                                th:text="${estadoOpt.name().replace('_', ' ')}"
                                th:selected="${estadoOpt == reservaDTO.estado}">
                        </option>
                    </select>
                </div>
                <div class="form-group mb-4">
                    <p class="services-label mb-2">Servicios adicionales:</p>

                    <div th:each="producto, iterStat : ${productos}" class="checkbox-group mb-3">
                        <div class="form-check mb-2">
                            <input type="checkbox"
                                   th:id="'producto_' + ${iterStat.index}"
                                   th:name="'productos[' + ${iterStat.index} + '].idProducto'"
                                   th:value="${producto.id}"
                                   th:attr="data-precio=${producto.precioBase}"
                                   class="form-check-input me-2" />
                            <label th:for="'producto_' + ${iterStat.index}"
                                   th:text="${producto.nombre}"
                                   class="form-check-label"></label>
                        </div>

                        <input type="number" th:name="'productos[' + ${iterStat.index} + '].cantidad'"
                               placeholder="Cantidad" class="form-control mb-1" style="max-width: 100px;" min="1"/>
                        <input type="date" th:name="'productos[' + ${iterStat.index} + '].fecha'"
                               class="form-control mb-1" style="max-width: 200px;"/>
                        <input type="number" th:name="'productos[' + ${iterStat.index} + '].descuento'"
                               placeholder="% desc" class="form-control mb-3" style="max-width: 100px;" min="0" max="100"/>
                    </div>

                    <div class="form-group mt-4">
                        <label>
                            <strong>Precio estimado total:</strong>
                            <span id="precioTotal">0 €</span>
                        </label>
                        <div id="desglosePrecio" style="font-size: 0.9em; color: #555;"></div>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary w-100">Guardar Reserva</button>
            </form>

            <p class="card-text text-center mt-4">¡Disponibilidad limitada! Reserva en segundos.</p>
        </div>
    </div>
</main>

</body>

</html>