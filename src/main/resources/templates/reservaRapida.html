<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layout/plantilla}">

<head>
    <title>Reserva Rápida</title>
</head>

<body class="bg-gradient-primary">

<main layout:fragment="contenido" id="main-content" class="main-container" role="main" aria-labelledby="booking-title">
    <div class="center-wrapper" style="min-height: 100vh; display: flex; align-items: center; justify-content: center; width: 100%;">
        <div class="card form-card" style="max-width: 512px; width: 100%; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
            <h1 id="booking-title" class="card-title text-center">Reserva Rápida</h1>

            <form th:action="@{/reservas/rapida}" th:object="${reservaDTO}" method="post" id="booking-form">

                <p class="card-text mb-4">Complete los campos para reservar su estancia. Todos los campos son obligatorios.</p>

                <!-- Campo oculto Hotel (id) -->
                <input type="hidden" th:field="*{hotel}" id="hotel" />

                <!-- Nombre -->
                <div class="form-group mb-4">
                    <label for="nombre">Nombre</label>
                    <input type="text" th:field="*{nombre}" id="nombre" class="form-control" required />
                </div>

                <!-- Email -->
                <div class="form-group mb-4">
                    <label for="email">Email</label>
                    <input type="email" th:field="*{email}" id="email" class="form-control" required />
                </div>

                <!-- Habitación (agrupada por hotel) -->
                <div class="form-group mb-4">
                    <label for="idHabitacion">Habitación</label>
                    <select th:field="*{idHabitacion}" id="idHabitacion" class="form-control" required>
                        <option value="" disabled selected>Seleccione habitación</option>

                        <!-- Agrupar por hotel -->
                        <th:block th:each="entry : ${habitacionesPorHotel}">
                            <optgroup th:label="${entry.key.nombre}">
                                <option th:each="habitacion : ${entry.value}"
                                        th:value="${habitacion.id}"
                                        th:text="${habitacion.tipo + ' - N° ' + habitacion.numeroHabitacion}"
                                        th:attr="data-hotel-id=${habitacion.hotel.id}">
                                </option>
                            </optgroup>
                        </th:block>
                    </select>
                </div>

                <!-- Fecha entrada -->
                <div class="form-group mb-4">
                    <label for="fechaEntrada">Fecha de Entrada</label>
                    <input type="date" th:field="*{fechaEntrada}" id="fechaEntrada" class="form-control" required />
                </div>

                <!-- Fecha salida -->
                <div class="form-group mb-4">
                    <label for="fechaSalida">Fecha de Salida</label>
                    <input type="date" th:field="*{fechaSalida}" id="fechaSalida" class="form-control" required />
                </div>

                <!-- Pax -->
                <div class="form-group mb-4">
                    <label for="pax">Número de huéspedes</label>
                    <input type="number" min="1" max="10" th:field="*{pax}" id="pax" class="form-control" required />
                </div>

                <!-- Comentarios -->
                <div class="form-group mb-4">
                    <label for="comentarios">Comentarios</label>
                    <textarea th:field="*{comentarios}" id="comentarios" class="form-control" rows="3" placeholder="Comentarios adicionales..."></textarea>
                </div>

                <!-- Productos opcionales -->
                <div class="form-group mb-4">
                    <p class="services-label mb-2">Servicios adicionales:</p>

                    <div th:each="producto, iterStat : ${productos}" class="checkbox-group mb-3">
                        <div class="form-check mb-2">
                            <input type="checkbox"
                                   th:id="'producto_' + ${iterStat.index}"
                                   th:name="'productos[' + ${iterStat.index} + '].idProducto'"
                                   th:value="${producto.id}"
                                   class="form-check-input me-2" />

                            <label th:for="'producto_' + ${iterStat.index}"
                                   th:text="${producto.nombre}"
                                   class="form-check-label"></label>
                        </div>

                        <input type="number"
                               th:name="'productos[' + ${iterStat.index} + '].cantidad'"
                               placeholder="Cantidad"
                               class="form-control mb-1"
                               style="max-width: 100px;" min="1" disabled />

                        <input type="date"
                               th:name="'productos[' + ${iterStat.index} + '].fecha'"
                               class="form-control mb-1"
                               style="max-width: 200px;" disabled />

                        <input type="number"
                               th:name="'productos[' + ${iterStat.index} + '].descuento'"
                               placeholder="% desc"
                               class="form-control mb-3"
                               style="max-width: 100px;" min="0" max="100" disabled />
                    </div>
                </div>

                <!-- Botón enviar -->
                <button type="submit" class="btn btn-grupo5 w-100 mt-3">Reservar Ahora</button>
            </form>

            <p class="card-text text-center mt-4">¡Disponibilidad limitada! Reserva en segundos.</p>
        </div>
    </div>
</main>

<!-- JS para sincronizar hotel según habitación y habilitar inputs productos -->
<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener("DOMContentLoaded", function () {
        const habitacionSelect = document.getElementById('idHabitacion');
        const hotelInput = document.getElementById('hotel');

        const actualizarHotel = () => {
            const selectedOption = habitacionSelect.options[habitacionSelect.selectedIndex];
            const hotelId = selectedOption ? selectedOption.getAttribute('data-hotel-id') : '';
            hotelInput.value = hotelId || '';
        };

        habitacionSelect.addEventListener('change', actualizarHotel);
        actualizarHotel();

        // Control para activar/desactivar inputs relacionados con productos opcionales
        document.querySelectorAll('.checkbox-group').forEach(function (group, index) {
            const checkbox = group.querySelector('input[type="checkbox"]');
            const inputs = group.querySelectorAll('input[type="number"], input[type="date"]');

            const toggleInputs = () => {
                const checked = checkbox.checked;
                console.log(`Producto #${index} checkbox está ${checked ? 'marcado' : 'desmarcado'}`);
                inputs.forEach(i => i.disabled = !checked);
            };

            // Escuchar cambios en el checkbox
            checkbox.addEventListener('change', toggleInputs);

            // Ejecutar una vez al cargar para establecer el estado correcto
            toggleInputs();
        });
    });
    /*]]>*/
</script>

</body>
</html>
